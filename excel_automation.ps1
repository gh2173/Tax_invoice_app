
# Excel ìë™í™” ìŠ¤í¬ë¦½íŠ¸ (ê°œì„ ëœ ë²„ì „)
$excelFilePath = "C:\\Users\\nepes\\Downloads\\DynamicsExport_638872039208168819.xlsx"
$vbaFilePath = "C:\\Users\\nepes\\OneDrive - ë„¤íŒ¨ìŠ¤\\ë°”íƒ• í™”ë©´\\PROJECT_GIT\\Electron_Test\\my-electron-app\\Tax_Invoice_app\\temp_macro.vba"

Write-Host "ğŸš€ Excel ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘"
Write-Host "íŒŒì¼ ê²½ë¡œ: $excelFilePath"

# ê¸°ì¡´ Excel í”„ë¡œì„¸ìŠ¤ í™•ì¸
$existingExcel = $null
try {
    $existingExcel = [System.Runtime.InteropServices.Marshal]::GetActiveObject("Excel.Application")
    Write-Host "âœ… ê¸°ì¡´ Excel ì• í”Œë¦¬ì¼€ì´ì…˜ ë°œê²¬"
} catch {
    Write-Host "ğŸ“‚ ìƒˆë¡œìš´ Excel ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘"
    $existingExcel = New-Object -ComObject Excel.Application
}

$excel = $existingExcel
$excel.Visible = $true
$excel.DisplayAlerts = $false

try {
    Write-Host "ğŸ“‚ ì—‘ì…€ íŒŒì¼ ì—´ê¸° ì¤‘..."
    
    # ì´ë¯¸ ì—´ë¦° íŒŒì¼ì¸ì§€ í™•ì¸
    $workbook = $null
    $fileName = [System.IO.Path]::GetFileName($excelFilePath)
    
    foreach($wb in $excel.Workbooks) {
        if ($wb.Name -eq $fileName) {
            $workbook = $wb
            Write-Host "âœ… ì´ë¯¸ ì—´ë¦° íŒŒì¼ ë°œê²¬: $fileName"
            break
        }
    }
    
    # íŒŒì¼ì´ ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ì—´ê¸°
    if ($workbook -eq $null) {
        $workbook = $excel.Workbooks.Open($excelFilePath)
        Write-Host "âœ… ì—‘ì…€ íŒŒì¼ ìƒˆë¡œ ì—´ê¸° ì™„ë£Œ"
    }
    
    # íŒŒì¼ ë¡œë”© ì™„ë£Œ ëŒ€ê¸°
    Start-Sleep -Seconds 5
    
    Write-Host "ğŸ“ VBA ë§¤í¬ë¡œ ì½”ë“œ ì½ê¸° ì¤‘..."
    
    # VBA ì½”ë“œ ì½ê¸°
    $vbaCode = Get-Content -Path $vbaFilePath -Raw
    
    Write-Host "ğŸ”§ VBA ë§¤í¬ë¡œ ëª¨ë“ˆ ì¶”ê°€ ì¤‘..."
    
    # ê¸°ì¡´ ëª¨ë“ˆì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì œê±°
    $vbaProject = $workbook.VBProject
    $existingModule = $null
    
    foreach($component in $vbaProject.VBComponents) {
        if ($component.Name -eq "AutoGeneratedModule") {
            $existingModule = $component
            break
        }
    }
    
    if ($existingModule -ne $null) {
        $vbaProject.VBComponents.Remove($existingModule)
        Write-Host "ğŸ—‘ï¸ ê¸°ì¡´ ë§¤í¬ë¡œ ëª¨ë“ˆ ì œê±°"
    }
    
    # VBA í”„ë¡œì íŠ¸ì— ìƒˆ ëª¨ë“ˆ ì¶”ê°€
    $vbaModule = $vbaProject.VBComponents.Add(1) # 1 = vbext_ct_StdModule
    $vbaModule.Name = "AutoGeneratedModule"
    
    # VBA ì½”ë“œ ì¶”ê°€
    $vbaModule.CodeModule.AddFromString($vbaCode)
    
    Write-Host "âœ… VBA ë§¤í¬ë¡œ ëª¨ë“ˆ ì¶”ê°€ ì™„ë£Œ"
    Write-Host "â–¶ï¸ ë§¤í¬ë¡œ ì‹¤í–‰ ì¤‘..."
    
    # ë§¤í¬ë¡œ ì‹¤í–‰
    $excel.Run("AutoGeneratedModule.GroupBy_I_Z_And_Process")
    
    Write-Host "ğŸ‰ ë§¤í¬ë¡œ ì‹¤í–‰ ì™„ë£Œ!"
    
    # íŒŒì¼ ì €ì¥
    $workbook.Save()
    Write-Host "ğŸ’¾ ì—‘ì…€ íŒŒì¼ ì €ì¥ ì™„ë£Œ"
    
    Write-Host "ğŸ¯ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
    
} catch {
    Write-Host "âŒ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "âŒ ìƒì„¸ ì˜¤ë¥˜: $($_.Exception.InnerException.Message)" -ForegroundColor Red
    throw
} finally {
    # Excel ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ê²°ê³¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡)
    Write-Host "ğŸ“Š Excel ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì—´ì–´ë‘¡ë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”."
    Write-Host "ğŸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ"
}
